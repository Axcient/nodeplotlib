"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const opn=require("opn"),express=require("express"),fs_1=require("fs"),path_1=require("path");exports.server={active:!1,loading:!1,instance:null};const app=express(),port=8080;let tempContainer=[];const plotContainer={};function clear(){tempContainer=[]}function stack(e){tempContainer.push(e)}function plot(e,t){e&&tempContainer.push(e);const n=Object.keys(plotContainer).length;return plotContainer[n]={opened:!1,pending:!1,request:!1,data:tempContainer},tempContainer=[],spawn(()=>{t&&t(n)}),n}function spawn(e){exports.server.active||exports.server.loading?exports.server.active&&(openPlots(),e()):(console.log("Open server"),exports.server.loading=!0,app.get("/data/:id",(e,t)=>{const n=e.params.id,r=plotContainer[n],o=r&&r.data;r.request=!0,t.send(o),close()}),app.get("/plots/:id",(e,t)=>{const n=e.params.id;fs_1.readFile(path_1.join(__dirname,"www","index.html"),"utf-8",(e,r)=>{fs_1.readFile(path_1.join(__dirname,"www","script.js"),"utf-8",(e,o)=>(o=o.replace("{{plotId}}",`${n}`),r=r.replace("{{script}}",o),t.send(r)))})}),exports.server.instance=app.listen(port,()=>{exports.server.active=!0,exports.server.loading=!1,openPlots(),e()}))}function openPlots(){const e=[];for(const t of Object.entries(plotContainer))t[1].opened||t[1].pending||(t[1].pending=!0,e.push(opn(`http://localhost:${port}/plots/${t[0]}`).then(()=>{t[1].opened=!0,t[1].pending=!1})))}function close(){const e=Object.values(plotContainer).map(e=>e.pending).reduce((e,t)=>e||t),t=Object.values(plotContainer).map(e=>e.request).reduce((e,t)=>e&&t);exports.server.instance&&exports.server.active&&!e&&t&&(console.log("Close server"),exports.server.instance.close(()=>{exports.server.instance=null}),exports.server.active=!1)}exports.clear=clear,exports.stack=stack,exports.plot=plot;